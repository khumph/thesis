---
title: 'Testbed: `r ifelse(params$noise & params$int, "Interaction and noise", ifelse(params$noise, "Noise", ifelse(params$int, "Interaction", "Original")))`'
output: html_notebook
params:
  noise: !r F
  noise_pred: !r F
  int: !r F
---

`r ifelse(params$int, "Interaction = half of people more sensitive to drug (toxicity increases 50% higher than usual with dose), half of people's tumor's reduce 50% more with dose", "Original")`

```{r, eval=FALSE, include=FALSE}
rm(list = ls())
```

```{r}
int <- params$int
noise <- params$noise
noise_pred <- params$noise_pred
```

`r ifelse (params$noise_pred, "Predictive noise", "")`

```{r setup}
knitr::opts_chunk$set(warning = F, message = F)
library(pacman)
p_load(tidyverse, rms, caret, gridExtra, stringr)
source("sim.R")
source("sim-test.R")
source("q-functs.R")
source("results-functs.R")
```

```{r}
# set.seed(20161116)
set.seed(20170408)
dat_long <- sim(int = int, noise = noise, noise_pred = noise_pred, Ttot = 6)
```

```{r formula}
if (int & !noise) {
  nms <- dat_long %>%
    select(tumor_mass, toxicity, dose, Qhat, starts_with("X")) %>% names()
} else if (noise & !int) {
  nms <- dat_long %>% select(tumor_mass, toxicity, dose, Qhat,
                        starts_with("Z"),
                        starts_with("V")) %>% names()
} else if (noise & int) {
  nms <- dat_long %>% select(tumor_mass, toxicity, dose, Qhat,
                             starts_with("X"),
                             starts_with("Z"),
                             starts_with("V")) %>% names()
} else {
  nms <- dat_long %>% select(tumor_mass, toxicity, dose, Qhat) %>% names()
}
response <- "Qhat"
treatment <- "dose"
pred_nms <- nms[!(nms %in% c(response, treatment))]
form <- paste(response,
                   "~",
                   paste0(c(pred_nms, treatment), collapse = " + ")) %>%
  as.formula()
```

```{r}
set.seed(20170321)
ex_ID <- sample(dat_long$ID, 1)
indPlot(dat_long, ex_ID)
```

# rpart
```{r}
# grid <- expand.grid(cp = 10^(seq(-4, -3, 1)))
Q_rpart <- Qlearn(
  form = form,
  dat_long,
  # tuneGrid = expand.grid(cp = 10^(seq(-7, -1, 1))),
  # trControl = trainControl(method = "cv"),
  method = 'rpart1SE',
  cp = 1e-5,
  maxsurrogate = 0,
  minbucket = 5
)
Q <- Q_rpart
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
```

# MARS
```{r}
#--- predictors in PREDICTORS are allowed to interact with predictors in PARENTS
#--- but no other interactions are allowed

PREDICTORS <- pred_nms
PARENTS <-  c("dose")
allowFunct <- function(degree, pred, parents, namesx) {
  if (degree <= 1)
    return(TRUE)
  predictor <- namesx[pred]
  parents <- namesx[parents != 0]
  if ((any(predictor %in% PREDICTORS) &&
       any(parents %in% PARENTS)) ||
      (any(predictor %in% PARENTS) &&
       any(parents %in% PREDICTORS))) {
    return(TRUE)
  }
  FALSE
}

set.seed(20170128)
Q_mars <- Qlearn(
  form,
  dat_long,
  method = 'gcvEarth',
  trControl = trainControl(method = "none"),
  nk = 200,
  allowed = allowFunct,
  tuneGrid = expand.grid(degree = 2)
)
Q <- Q_mars
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred, mon = 5)
```

# bagMARS
```{r}
set.seed(20170128)
Q_bmars <- Qlearn(
  form,
  dat_long,
  method = 'bagEarthGCV',
  trControl = trainControl(method = "none"),
  nk = 200,
  allowed = allowFunct,
  tuneGrid = expand.grid(degree = 2)
)
Q <- Q_bmars
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred, mon = 5)
```

# rf
```{r}
grid <- expand.grid(mtry = floor(seq(length(pred_nms) / 2, length(pred_nms), length = 4)))
# grid <- expand.grid(mtry = floor(sqrt(length(pred_nms))))

Q_rf <- Qlearn(
  form,
  dat_long,
  method = 'ranger',
  tuneGrid = grid,
  trControl = trainControl(method = "adaptive_boot",
                           adaptive = list(min = 5, alpha = 0.05,
                                           method = "gls", complete = F)),
  min.node.size = 5,
  importance = "impurity",
  always.split.variables = c("dose"),
  num.trees = 500
)

Q <- Q_rf
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
```

```{r}
Q_list <- list(CART = Q_rpart, MARS = Q_mars, BMARS = Q_bmars, RF = Q_rf)
dat_test <- map_df(1:25, ~ sim_test(Q_list, int = int, noise = noise,
                               noise_pred = noise_pred, seed = .x) %>%
                 mutate(rep = .x)) %>% mutate(group = factor(
    group,
    levels = c(
      seq(from = 0.1, to = 1, by = 0.1) %>% as.character(),
      '1on1off',
      names(Q_list), "greedy"
    )
  ))

dat <- dat_test %>% group_by(group, ID, month) %>%
  summarise_all(funs(mean(., na.rm = T)))
```

```{r}
type_nm <- paste0(
  ifelse(int, "int", ""),
  ifelse(int & noise, "_", ""),
  ifelse(noise, "noise", ""),
  ifelse(noise_pred, "_pred", ""),
  ifelse(!noise_pred & !noise & !int, "orig", "")
)
prefix <- c("dat_test_", "dat_", "Q_list_")
var_nms <- map_chr(prefix, ~ paste0(.x, type_nm))
for (i in 1:length(var_nms)) {
  assign(var_nms[[i]], list(dat_test, dat, Q_list)[[i]])
}
save(list = var_nms, file = paste0(type_nm, ".Rdata"))
```

```{r}
reward_plot(dat, Q_list)
```

```{r}
plots_tab(dat_test)
```




