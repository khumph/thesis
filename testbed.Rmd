---
title: 'Testbed: `r ifelse(params$noise, "Noise", ifelse(params$int, "Interaction", "Original"))`'
output: html_document
params:
  noise: !r T
  int: !r F
---

```{r, eval=FALSE, include=FALSE}
rm(list = ls())
int <- F
noise <- T
```

```{r}
int <- params$int
noise <- params$noise
```

```{r setup}
knitr::opts_chunk$set(warning = F, message = F)
library(pacman)
p_load(tidyverse, rms, caret, gridExtra, stringr)
source("surv-sim-functs.R")
source("surv-sim.R")
source("q-functs.R")
source("surv-sim-test.R")
source("results-functs.R")
```

```{r sim}
set.seed(20161116)
dat_long <- sim(int = int, noise = noise)
```

```{r}
nms <- dat_long %>% select(-ID, -month, -dead, -M_next, -W_next, -d_next, -reward, -best, -surv_time) %>% names()
response <- "Qhat"
treatment <- "dose"
pred_nms <- nms[!(nms %in% response)]
form_base <- paste(response,
                   "~",
                   paste0(pred_nms, collapse = " + "))
ints <- paste0(pred_nms[!(pred_nms %in% treatment)], ":", treatment)
ints <- paste(ints, collapse = " + ")
formula <- paste(c(form_base, ints), collapse = " + ")
form <- as.formula(form_base)
form_int <- as.formula(formula)
```


```{r}
set.seed(20170207)
ex_ID <- sample(dat_long$ID, 1)
indPlot(dat_long, ex_ID)
```

# lm
```{r}
Q_lm <- Qlearn(
  data = dat_long,
  formula = form_int,
  treatment = "dose",
  mod_type = "caret",
  method = 'lm'
)
Q <- Q_lm
```

```{r}
set.seed(20170206)
maxPlots(Q, ex_ID)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```


<!-- # RCS -->
<!-- ```{r} -->
<!-- set.seed(20170128) -->
<!-- Q_rcs <- Qlearn( -->
<!--   data = dat_long, -->
<!--   formula = form, -->
<!--   treatment = "dose", -->
<!--   mod_type = "rcs" -->
<!-- ) -->
<!-- Q <- Q_rcs -->
<!-- ``` -->

<!-- ```{r} -->
<!-- set.seed(20170206) -->
<!-- maxPlots(Q, ex_ID) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- set.seed(20170128) -->
<!-- sim_test(Q, int = int, noise = noise) %>% plots_tab() -->
<!-- ``` -->

# GLMNET
```{r}
set.seed(20170128)
Q_glmnet <- Qlearn(
  data = dat_long,
  formula = form_int,
  treatment = "dose",
  mod_type = "caret",
  method = "glmnet"
)
Q <- Q_glmnet
```

```{r}
set.seed(20170206)
maxPlots(Q, ex_ID)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```


# rpart
```{r}
Q_rpart <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  method = 'rpart'
)
Q <- Q_rpart
```

```{r}
set.seed(20170206)
maxPlots(Q, ex_ID)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```


<!-- # ERT -->
<!-- ```{r} -->
<!-- # Tuning parameters: -->
<!-- #   mtry (# Randomly Selected Predictors) - also K ? -->
<!-- #   numRandomCuts (# Random Cuts) - K in CRT paper ? -->

<!-- # grid <- expand.grid(mtry = 3, numRandomCuts = 1) -->

<!-- Q_ert <- Qlearn( -->
<!--   data = dat_long, -->
<!--   formula = form, -->
<!--   treatment = "dose", -->
<!--   mod_type = "caret", -->
<!--   method = 'extraTrees', -->
<!--   # tuneGrid = grid, -->
<!--   ntree = 50, -->
<!--   # G in CRT paper -->
<!--   nodesize = 2 # nmin in CRT paper -->
<!-- ) -->

<!-- Q <- Q_ert -->
<!-- ``` -->

<!-- ```{r} -->
<!-- set.seed(20170206) -->
<!-- maxPlots(Q, ex_ID) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- set.seed(20170128) -->
<!-- sim_test(Q, int = int, noise = noise) %>% plots_tab() -->
<!-- ``` -->

# MARS
```{r}
set.seed(20170128)
Q_mars <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  method = 'gcvEarth',
  tuneGrid = expand.grid(degree = 2)
)
Q <- Q_mars
```

```{r}
set.seed(20170206)
maxPlots(Q, ex_ID)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```
