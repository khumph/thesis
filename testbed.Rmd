---
title: 'Testbed: `r ifelse(params$noise, "Noise", ifelse(params$int, "Interaction", "Original"))` negative of tumor mass is only reward'
output: html_document
params:
  noise: !r F
  int: !r F
---

`r ifelse(params$noise, "Noise", ifelse(params$int, "Interaction = half of people more sensitive to drug (toxicity increases 50% higher than usual with dose), half of people's tumor's reduce 50% more with dose", "Original"))`

```{r, eval=F}
rm(list = ls())
```

```{r}
int <- params$int
noise <- params$noise
noise_pred <- F
```

`r ifelse (noise & !noise_pred, "No predicitive noise", "")`

```{r setup}
knitr::opts_chunk$set(warning = F, message = F)
library(pacman)
p_load(tidyverse, rms, caret, gridExtra, stringr)
source("sim-functs.R")
source("sim.R")
source("q-functs.R")
source("sim-test.R")
source("results-functs.R")
```

```{r sim}
set.seed(20161116)
dat_long <- sim(int = int, noise = noise, noise_pred = noise_pred)
```

```{r formula}
if (int) {
  nms <-
    dat_long %>% select(tumor_mass, toxicity, dose, Qhat, starts_with("X")) %>% names()
} else if (noise) {
  nms <-
    dat_long %>% select(tumor_mass, toxicity, dose, Qhat,
                        starts_with("Z"),
                        starts_with("V")) %>% names()
} else {
  nms <-
    dat_long %>% select(tumor_mass, toxicity, dose, Qhat) %>% names()
}
response <- "Qhat"
treatment <- "dose"
pred_nms <- nms[!(nms %in% response)]
form_base <- paste(response,
                   "~",
                   paste0(pred_nms, collapse = " + "))
ints <- paste0(pred_nms[!(pred_nms %in% treatment)], ":", treatment)
ints <- paste(ints, collapse = " + ")
formula <- paste(c(form_base, ints), collapse = " + ")
form <- as.formula(form_base)
form_int <- as.formula(formula)
```

```{r}
set.seed(20170321)
ex_ID <- sample(dat_long$ID, 1)
indPlot(dat_long, ex_ID)
```

# rcs
```{r}
if (!noise) {
  set.seed(20170128)
  Q_rcs <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "rcs"
  )
  Q <- Q_rcs
}
```

```{r}
if (!noise) {
  maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
}
```

```{r}
if (!noise) {
  set.seed(20170128)
  sim_test(Q, int = int, noise = noise, noise_pred = noise_pred) %>% plots_tab()
}
```


# rpart
```{r}
grid <- expand.grid(cp = 10^(seq(-4, -3, 1)))
Q_rpart <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  tuneGrid = grid,
  method = 'rpart',
  minbucket = 2
)
Q <- Q_rpart
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise, noise_pred = noise_pred) %>% plots_tab()
```

# MARS
```{r}
set.seed(20170128)
Q_mars <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  method = 'gcvEarth',
  tuneGrid = expand.grid(degree = 2)
)
Q <- Q_mars
```

```{r}
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
```

```{r, eval = F}
set.seed(20170128)
dat <- map_df(1:10, ~ sim_test(Q, int = int, noise = noise, noise_pred = noise_pred)) %>%
  group_by(group, ID, month) %>%
  summarise_all(funs(mean(., na.rm = T)))
dat %>% plots_tab() 
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise, noise_pred = noise_pred) %>% plots_tab()
```


# rf
```{r}
if (noise) {
  grid <- expand.grid(mtry = seq(from = 0, to = 10, by = 5))
  splitvars <- c("dose", "tumor_mass", "toxicity")
} else if (int) {
  grid <- expand.grid(mtry = seq(from = 0, to = 2, by = 1))
  splitvars <- c("dose", "tumor_mass", "toxicity")
} else {
  grid <- expand.grid(mtry = 2)
  splitvars <- c("dose")
}

Q_rf <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  method = 'ranger',
  tuneGrid = grid,
  min.node.size = 2,
  importance = "impurity",
  num.trees = 100,
  always.split.variables = splitvars
)

Q <- Q_rf
```

```{r}
set.seed(20170329)
maxPlots(Q, ex_ID, int = int, noise_pred = noise_pred)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise, noise_pred = noise_pred) %>% plots_tab()
```