---
title: 'Testbed: `r ifelse(params$noise, "Noise", ifelse(params$int, "Interaction", "Original"))`'
output: html_document
params:
  noise: F
  int: F
---

```{r, eval=FALSE, include=FALSE}
rm(list = ls())
int <- F
noise <- F
```

```{r setup}
int <- params$int
noise <- params$noise
knitr::opts_chunk$set(warning = F, message = F)
library(pacman)
p_load(tidyverse, caret, gridExtra, stringr)
```

```{r sim}
source("sim.R")
source("q-functs.R")
set.seed(20161116)
dat_long <- sim(int = int, noise = noise)
```

```{r}
if (int) {
  form <- Q_hat ~ tumor_mass + dose + toxicity + X
  form_int <- Q_hat ~ tumor_mass + dose + toxicity + X + dose * tumor_mass +
    dose * toxicity + dose * X
} else if (noise) {
  form <- Q_hat ~ tumor_mass + dose + toxicity + V1 + V2 + V3 + V4 + V5 +
    V6 + V7 + V8 + V9 + V10
  form_int <- Q_hat ~ tumor_mass + dose + toxicity + V1 + V2 + V3 + V4 + V5 +
    V6 + V7 + V8 + V9 + V10 +
    dose * tumor_mass + dose * toxicity + dose * V1 + dose * V2 + dose * V3 +
    dose * V4 + dose * V5 + dose * V6 + dose * V7 + dose * V8 + dose * V9 +
    dose * V10
} else {
  form <- Q_hat ~ tumor_mass + dose + toxicity
  form_int <- Q_hat ~ tumor_mass + dose + toxicity + dose * tumor_mass +
    dose * toxicity
}
```


```{r}
set.seed(20170207)
indPlot(dat_long)
```

# RCS
```{r}
set.seed(20170128)
Q_rcs <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "rcs"
)
Q <- Q_rcs
```

```{r}
set.seed(20170206)
maxPlots(Q)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```

# GLMNET
```{r}
set.seed(20170128)
Q_glmnet <- Qlearn(
  data = dat_long,
  formula = form_int,
  treatment = "dose",
  mod_type = "caret",
  na.action = na.omit,
  method = "glmnet"
)
Q <- Q_glmnet
```

```{r}
set.seed(20170206)
maxPlots(Q)
```


```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```


# ERT
```{r ert-qlearn}
# Tuning parameters:
#   mtry (# Randomly Selected Predictors) - also K ?
#   numRandomCuts (# Random Cuts) - K in CRT paper ?

grid <- expand.grid(mtry = 3,
                    numRandomCuts = 1)

Q_ert <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  method = 'extraTrees',
  na.action = na.omit,
  tuneGrid = grid,
  ntree = 50, # G in CRT paper
  nodesize = 2 # nmin in CRT paper
)
Q <- Q_ert
```

```{r}
set.seed(20170206)
maxPlots(Q)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```

# MARS 
```{r}
set.seed(20170128)
Q_mars <- Qlearn(
  data = dat_long,
  formula = form,
  treatment = "dose",
  mod_type = "caret",
  na.action = na.omit,
  method = 'gcvEarth',
  tuneGrid = expand.grid(degree = 3)
)
Q <- Q_mars
```

```{r}
set.seed(20170206)
maxPlots(Q)
```

```{r}
set.seed(20170128)
sim_test(Q, int = int, noise = noise) %>% plots_tab()
```


